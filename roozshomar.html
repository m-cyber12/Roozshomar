<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>روزشمار — تا ۱ مهر</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --accent:#ffb86b; --muted:#9aa4b2; --glass: rgba(255,255,255,0.04);
      --radius:18px;
      font-family: 'Tahoma','Vazir','Yekan', system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans';
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(ellipse at 10% 10%, rgba(255,184,107,0.07), transparent 20%),
                  linear-gradient(180deg,#071428 0%, var(--bg) 100%);
      color:#e6eef8; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:100%;max-width:920px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:28px;border-radius:22px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-size:1.6rem}
    p.lead{margin:6px 0 0;color:var(--muted)}

    .timer{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:22px}
    .unit{background:var(--glass);padding:18px;border-radius:14px;text-align:center;backdrop-filter:blur(6px)}
    .num{font-size:2.4rem;font-weight:700;margin-bottom:6px}
    .label{font-size:0.92rem;color:var(--muted)}

    .controls{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
    button, .linklike{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:12px;color:inherit;cursor:pointer}
    .primary{background:linear-gradient(90deg,var(--accent),#ff8a65);color:#08101a;border:none}

    footer{margin-top:18px;color:var(--muted);font-size:0.9rem}

    @media (max-width:560px){.timer{grid-template-columns:repeat(2,1fr)}.num{font-size:1.8rem}}
    .small{font-size:0.85rem;color:var(--muted)}

    .title-input{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

    .top-row{display:flex;gap:12px;align-items:center;width:100%}
    .flex{flex:1}

    .preview-canvas{display:block;margin-top:16px;border-radius:12px;max-width:100%;}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div style="flex:1">
          <h1 id="pageTitle">روزشمار</h1>
          <p class="lead">نمایش لحظه‌ای تا شروع مدرسه — ۱ مهر (قابل اشتراک)</p>
        </div>
        <div style="text-align:left">
          <div class="small">قابل اشتراک — بدون نیاز به نصب</div>
        </div>
      </header>

      <div style="margin-top:16px;">
        <div class="top-row">
          <input id="titleInput" class="title-input flex" placeholder="عنوان (مثلاً: شروع مدرسه‌ها — ۱ مهر)" />
          <input id="dateInput" class="title-input" style="width:220px" type="date" />
        </div>

        <div class="timer" aria-live="polite" id="timer">
          <div class="unit">
            <div class="num" id="days">0</div>
            <div class="label">روز</div>
          </div>
          <div class="unit">
            <div class="num" id="hours">0</div>
            <div class="label">ساعت</div>
          </div>
          <div class="unit">
            <div class="num" id="minutes">0</div>
            <div class="label">دقیقه</div>
          </div>
          <div class="unit">
            <div class="num" id="seconds">0</div>
            <div class="label">ثانیه</div>
          </div>
        </div>

        <div class="controls">
          <button class="primary" id="copyLink">کپی لینک قابل اشتراک</button>
          <button id="downloadHTML">دانلود فایل HTML</button>
          <button id="snapshot">دانلود عکس (PNG)</button>
          <button id="setDefault">تنظیم ۱ مهر</button>
          <button id="reset">بازنشانی</button>
        </div>

        <canvas id="canvas" class="preview-canvas" width="900" height="260" style="display:none"></canvas>

        <footer>
          <div>راهنما: تاریخ را می‌توانی از ورودی بالا تغییر دهی. برای اشتراک ساده، لینک را کپی کن و در گروه بچسبان.</div>
          <div style="margin-top:6px" class="small">اگر این فایل را روی یک هاست استاتیک (مثلاً GitHub Pages) قرار دهی، لینک با پارامترهای `?date=YYYY-MM-DD&title=...` قابل اشتراک مستقیم خواهد بود.</div>
        </footer>
      </div>
    </div>
  </div>

  <script>
    // تنظیم پیش‌فرض: 2025-09-23 معادل 1 مهر 1404
    function toPersianDigits(s){
      const map = {0:'۰',1:'۱',2:'۲',3:'۳',4:'۴',5:'۵',6:'۶',7:'۷',8:'۸',9:'۹'};
      return String(s).replace(/\d/g, d=>map[d]);
    }

    const params = new URLSearchParams(location.search);
    const inputDate = document.getElementById('dateInput');
    const titleInput = document.getElementById('titleInput');
    const pageTitle = document.getElementById('pageTitle');

    // load from URL params or defaults
    const defaultDate = '2025-09-23';
    const dateParam = params.get('date') || defaultDate;
    const titleParam = params.get('title') || 'شروع مدرسه‌ها — ۱ مهر';

    inputDate.value = dateParam;
    titleInput.value = titleParam;
    pageTitle.textContent = titleParam;

    // update title on change
    titleInput.addEventListener('input', ()=>{ pageTitle.textContent = titleInput.value || 'روزشمار'; saveState(); });

    inputDate.addEventListener('change', ()=>{ saveState(); });

    // persist
    function saveState(){
      localStorage.setItem('countdown_date', inputDate.value);
      localStorage.setItem('countdown_title', titleInput.value);
    }
    function loadState(){
      const d = localStorage.getItem('countdown_date');
      const t = localStorage.getItem('countdown_title');
      if(d) inputDate.value = d;
      if(t) {titleInput.value = t; pageTitle.textContent = t}
    }
    loadState();

    // countdown logic
    function getTargetTime(){
      // treat date as midnight local time
      return new Date(inputDate.value + 'T00:00:00').getTime();
    }

    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');

    function updateTimer(){
      const now = Date.now();
      const target = getTargetTime();
      let diff = target - now;
      if(isNaN(target)) return;
      if(diff <= 0){
        daysEl.textContent = '۰'; hoursEl.textContent='۰'; minutesEl.textContent='۰'; secondsEl.textContent='۰';
        document.title = pageTitle.textContent + ' — رسید!';
        return;
      }
      const d = Math.floor(diff / (1000*60*60*24));
      diff -= d*24*60*60*1000;
      const h = Math.floor(diff / (1000*60*60));
      diff -= h*1000*60*60;
      const m = Math.floor(diff / (1000*60));
      const s = Math.floor((diff/1000) % 60);

      daysEl.textContent = toPersianDigits(d);
      hoursEl.textContent = toPersianDigits(h);
      minutesEl.textContent = toPersianDigits(m);
      secondsEl.textContent = toPersianDigits(s);
      document.title = `${toPersianDigits(d)} روز مانده — ${pageTitle.textContent}`;
    }

    setInterval(updateTimer, 250);
    updateTimer();

    // buttons
    document.getElementById('setDefault').addEventListener('click', ()=>{ inputDate.value = '2025-09-23'; titleInput.value='شروع مدرسه‌ها — ۱ مهر'; pageTitle.textContent = titleInput.value; saveState(); updateTimer(); });
    document.getElementById('reset').addEventListener('click', ()=>{ localStorage.removeItem('countdown_date'); localStorage.removeItem('countdown_title'); inputDate.value = defaultDate; titleInput.value = titleParam; pageTitle.textContent = titleParam; saveState(); updateTimer(); });

    // copy link
    document.getElementById('copyLink').addEventListener('click', async ()=>{
      const base = location.origin + location.pathname; // works when hosted
      const u = new URL(base);
      u.searchParams.set('date', inputDate.value);
      u.searchParams.set('title', titleInput.value);
      const final = u.toString();
      try{
        await navigator.clipboard.writeText(final);
        alert('لینک کپی شد. کافیست در گروه بچسبانید.');
      }catch(e){
        prompt('لینک را کپی کنید:', final);
      }
    });

    // download HTML (saves current file with current params embedded)
    document.getElementById('downloadHTML').addEventListener('click', ()=>{
      const html = `<!doctype html>${document.documentElement.outerHTML}`;
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'roozshomar.html';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // snapshot to PNG
    document.getElementById('snapshot').addEventListener('click', ()=>{
      // draw a simple image of the timer onto canvas
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const w = canvas.width; const h = canvas.height;
      // background
      const grad = ctx.createLinearGradient(0,0,w,h);
      grad.addColorStop(0,'#071428'); grad.addColorStop(1,'#0f172a');
      ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);

      // title
      ctx.fillStyle = '#ffffff'; ctx.font = '28px Tahoma'; ctx.textAlign='right';
      ctx.fillText(titleInput.value || pageTitle.textContent, w-40, 48);

      // draw boxes
      const units = [daysEl.textContent, hoursEl.textContent, minutesEl.textContent, secondsEl.textContent];
      const labels = ['روز','ساعت','دقیقه','ثانیه'];
      const boxW = Math.floor((w-140)/4);
      for(let i=0;i<4;i++){
        const x = 40 + i*(boxW+20);
        const y = 80;
        // box
        ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.roundRect = function(x,y,wd,ht,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+wd,y,x+wd,y+ht,r);ctx.arcTo(x+wd,y+ht,x,y+ht,r);ctx.arcTo(x,y+ht,x,y,r);ctx.arcTo(x,y,x+wd,y,r);ctx.closePath();ctx.fill();}
        ctx.roundRect(x,y,boxW,120,14);
        // number
        ctx.fillStyle = '#fff'; ctx.font = '44px Tahoma'; ctx.textAlign='center'; ctx.fillText(units[i], x+boxW/2, y+68);
        // label
        ctx.fillStyle = '#b8c2cf'; ctx.font = '20px Tahoma'; ctx.fillText(labels[i], x+boxW/2, y+102);
      }

      // export
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = url; a.download = 'roozshomar.png'; a.click();
    });

    // allow opening with query params when run as file:// — if running as file, origin is null; copy link will still produce an anchored relative path
  </script>
</body>
</html>
